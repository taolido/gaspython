# 4-2. 「壊さない」ための鉄則3つ

## この節で学ぶこと

- Pythonの環境が「壊れる」とはどういう状態か
- 環境を壊さないための3つの鉄則
- なぜvenv（仮想環境）が必要なのか

---

## まず理解する：環境が「壊れる」とは

Pythonの環境が「壊れる」とは、以下のような状態です：

```
┌─────────────────────────────────────────────────────────────┐
│  「壊れた」状態の例                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ✗ 昨日まで動いていたコードが動かなくなった                │
│                                                              │
│  ✗ pip install するとエラーが出る                          │
│    ERROR: Cannot install package-A and package-B because    │
│    these versions have conflicting dependencies             │
│                                                              │
│  ✗ import pandas すると別のライブラリのエラーが出る        │
│                                                              │
│  ✗ Pythonを再インストールしても直らない                     │
│                                                              │
│  ✗ どのライブラリが悪いのか分からない                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**GASでは経験したことがない問題です。** なぜなら、GASには「環境」という概念がなかったからです。

---

## なぜ環境は壊れるのか

### 原因1：依存関係の競合

```
┌─────────────────────────────────────────────────────────────┐
│  依存関係の競合                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  プロジェクトA:                                              │
│    pandas 2.0 が必要                                        │
│    pandas 2.0 は numpy 1.24 以上が必要                      │
│                                                              │
│  プロジェクトB:                                              │
│    tensorflow 2.10 が必要                                   │
│    tensorflow 2.10 は numpy 1.23 以下が必要                 │
│                                                              │
│  → numpy のバージョンが競合！                               │
│  → 両方を同じ環境に入れると壊れる                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 原因2：グローバル環境の汚染

```
┌─────────────────────────────────────────────────────────────┐
│  グローバル環境の汚染                                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1日目: プロジェクトAのために pandas をインストール         │
│  2日目: プロジェクトBのために tensorflow をインストール    │
│  3日目: プロジェクトCのために 古いバージョンの何かを入れる │
│  ...                                                         │
│  30日目: 何が入っているか分からない状態に                   │
│                                                              │
│  → 「さっきまで動いていたのに」が頻発                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 鉄則1：グローバル環境には絶対インストールしない

### グローバル環境とは

Pythonをインストールした直後の状態が「グローバル環境」です。

```
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│  C:\Python311\                    ← グローバル環境          │
│  ├── python.exe                                              │
│  └── Lib\                                                    │
│      └── site-packages\          ← ここにライブラリが入る   │
│          ├── pip                                             │
│          └── （ここに直接 pip install すると危険！）        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### なぜ危険か

```
グローバル環境に直接インストールすると:

pip install pandas
pip install tensorflow
pip install django
pip install flask
...

→ 全プロジェクトが同じライブラリを共有
→ 1つを更新すると、他に影響
→ バージョン競合が発生しやすい
→ 「何が入っているか」が管理できなくなる
```

### 鉄則

```
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│    グローバル環境への pip install は禁止                    │
│                                                              │
│    python -m pip install pandas  ← NG                      │
│                                                              │
│    代わりに「仮想環境」を使う                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 鉄則2：プロジェクトごとにvenv（仮想環境）を作る

### venvとは

**venv（仮想環境）** は、プロジェクト専用の隔離されたPython環境です。

```
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│  仮想環境のイメージ                                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  プロジェクトA/                                      │    │
│  │  ├── venv/                 ← プロジェクトA専用の環境│    │
│  │  │   └── Lib/site-packages/                         │    │
│  │  │       ├── pandas 2.0                             │    │
│  │  │       └── numpy 1.24                             │    │
│  │  └── main.py                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  プロジェクトB/                                      │    │
│  │  ├── venv/                 ← プロジェクトB専用の環境│    │
│  │  │   └── Lib/site-packages/                         │    │
│  │  │       ├── tensorflow 2.10                        │    │
│  │  │       └── numpy 1.23                             │    │
│  │  └── main.py                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  → 互いに影響しない！                                       │
│  → プロジェクトAでpandas更新しても、Bには影響なし          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### venvの基本操作（プレビュー）

```bash
# 1. 仮想環境を作成
python -m venv venv

# 2. 仮想環境を有効化（Windows）
.\venv\Scripts\activate

# 3. 有効化されると、プロンプトが変わる
(venv) C:\project>

# 4. この状態で pip install すると、venv内にインストールされる
(venv) C:\project> pip install pandas

# 5. 作業が終わったら無効化
(venv) C:\project> deactivate
```

### なぜvenvを使うのか

| 状況 | venvなし | venvあり |
|------|---------|---------|
| ライブラリ更新 | 全プロジェクトに影響 | そのプロジェクトだけ |
| バージョン競合 | 発生しやすい | 発生しない |
| 環境の再現 | 困難 | requirements.txtで簡単 |
| 環境が壊れたら | 全体が壊れる | そのvenvだけ削除すればOK |

---

## 鉄則3：壊れたら直さない、捨てて作り直す

### 「直そうとする」の罠

```
┌─────────────────────────────────────────────────────────────┐
│  よくある失敗パターン                                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  環境が壊れた                                                │
│      ↓                                                       │
│  「直そう」と pip uninstall / pip install を繰り返す        │
│      ↓                                                       │
│  さらに状況が悪化                                            │
│      ↓                                                       │
│  「Pythonを再インストールしよう」                           │
│      ↓                                                       │
│  グローバル環境が汚染されたまま、問題が続く                 │
│      ↓                                                       │
│  何時間も格闘                                                │
│      ↓                                                       │
│  挫折                                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 正しい対処法

```
┌─────────────────────────────────────────────────────────────┐
│  正しいパターン                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  venv環境が壊れた                                            │
│      ↓                                                       │
│  venvフォルダを削除                                          │
│      ↓                                                       │
│  新しいvenvを作成                                            │
│      ↓                                                       │
│  requirements.txtから再インストール                         │
│      ↓                                                       │
│  5分で復旧完了                                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### コマンドで言うと

```bash
# 壊れた venv を削除（Windowsの場合）
rmdir /s /q venv

# 新しい venv を作成
python -m venv venv

# 有効化
.\venv\Scripts\activate

# requirements.txt から再インストール
pip install -r requirements.txt

# 完了！
```

**「壊れた環境を直そうとするのは、絡まったイヤホンをほどくようなもの。捨てて新しく作る方が速い」**

---

## 補足：requirements.txtとは

venvと一緒に使う「設計図」のようなファイルです。

### 作成方法

```bash
# 現在の環境にインストールされているライブラリを書き出す
pip freeze > requirements.txt
```

### 中身の例

```
# requirements.txt
pandas==2.0.3
openpyxl==3.1.2
numpy==1.24.0
```

### 復元方法

```bash
# requirements.txt から一括インストール
pip install -r requirements.txt
```

### なぜ必要か

```
┌─────────────────────────────────────────────────────────────┐
│  requirements.txt があれば...                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ✓ 環境が壊れても5分で復旧できる                           │
│  ✓ 別のPCでも同じ環境を再現できる                          │
│  ✓ チームで環境を共有できる                                │
│  ✓ 「何がインストールされているか」が明確                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3つの鉄則まとめ

```
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│  鉄則1: グローバル環境には絶対インストールしない            │
│         → 必ず venv を作ってからインストール               │
│                                                              │
│  鉄則2: プロジェクトごとに venv を作る                      │
│         → 1プロジェクト = 1 venv                           │
│         → 互いに影響しない                                  │
│                                                              │
│  鉄則3: 壊れたら直さない、捨てて作り直す                    │
│         → venv を削除 → 新規作成 → requirements.txt       │
│         → 5分で復旧                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## GAS経験者への補足

GASには「環境」という概念がありませんでした。

```
GAS:
・Googleがすべて管理
・ライブラリの競合は起きない
・「壊れる」ことがない

Python:
・自分で環境を管理する
・ライブラリの競合が起きる
・「壊れる」ことがある
・だから「壊さない作法」が必要
```

**venvは「保険」ではなく「作法」です。歯磨きと同じで、やらない選択肢はありません。**

---

## キーメッセージ

> **「Pythonは自由な言語です。自由すぎて、自分の環境を壊す自由もあります」**

> **「venvは『保険』ではなく『作法』です。歯磨きと同じで、やらない選択肢はありません」**

> **「壊れた環境を直そうとするのは、絡まったイヤホンをほどくようなもの。捨てて新しく作る方が速い」**

> **「プロのエンジニアでも環境を壊します。違いは『壊れても5分で復旧できる』こと」**

---

## この節のまとめ

- 環境が「壊れる」とは、依存関係の競合でライブラリが正常に動作しなくなる状態
- 鉄則1：グローバル環境には絶対インストールしない
- 鉄則2：プロジェクトごとにvenvを作る
- 鉄則3：壊れたら直さない、捨てて作り直す
- requirements.txtで環境を「見える化」する

**次の節では、実際にPythonをインストールします。**
