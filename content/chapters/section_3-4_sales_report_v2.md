# 3-4. ã€å®Ÿè·µã€‘ã‚°ãƒ©ãƒ•ä»˜ãå£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ

## ã“ã®ç¯€ã§å­¦ã¶ã“ã¨

- å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§é›†è¨ˆã™ã‚‹
- Excelã«ã‚°ãƒ©ãƒ•ã‚’è‡ªå‹•æŒ¿å…¥ã™ã‚‹
- è¦‹æ „ãˆã®è‰¯ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
- çµŒç†éƒ¨ã«æ¸¡ã›ã‚‹å“è³ªã®Excelã‚’ä½œã‚‹

---

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

ã“ã®ç¯€ã§ä½œã‚‹ãƒ¬ãƒãƒ¼ãƒˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ_2024å¹´1æœˆ.xlsx                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ã€Sheet1: ã‚µãƒãƒªãƒ¼ã€‘                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2024å¹´1æœˆ å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ                              â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  ç·å£²ä¸Š: Â¥12,345,678                                 â”‚   â”‚
â”‚  â”‚  å–å¼•ä»¶æ•°: 156ä»¶                                      â”‚   â”‚
â”‚  â”‚  å¹³å‡å˜ä¾¡: Â¥79,139                                   â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“Š éƒ¨é–€åˆ¥å£²ä¸Šã‚°ãƒ©ãƒ•                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ å–¶æ¥­éƒ¨ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 52%                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ é–‹ç™ºéƒ¨ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 33%                      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ ç·å‹™éƒ¨ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15%                           â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  ã€Sheet2: è©³ç´°ãƒ‡ãƒ¼ã‚¿ã€‘                                      â”‚
â”‚  æ—¥ä»˜ | éƒ¨ç½² | å•†å“ | é‡‘é¡ | ...                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã€ŒçµŒç†éƒ¨ã«æ¯æœˆæ¸¡ã™ãƒ¬ãƒãƒ¼ãƒˆã€ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚**

---

## Step 0: ã‚µãƒ³ãƒ—ãƒ«å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ

ã¾ãšã¯ç·´ç¿’ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# ===== Step 0: ã‚µãƒ³ãƒ—ãƒ«å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ =====
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# å†ç¾å¯èƒ½ãªä¹±æ•°
np.random.seed(42)

# ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
n_rows = 200
departments = ['å–¶æ¥­éƒ¨', 'é–‹ç™ºéƒ¨', 'ç·å‹™éƒ¨']
products = ['å•†å“A', 'å•†å“B', 'å•†å“C', 'å•†å“D']
sales_reps = ['ç”°ä¸­', 'éˆ´æœ¨', 'ä½è—¤', 'é«˜æ©‹', 'ä¼Šè—¤', 'æ¸¡è¾º']

# 2024å¹´1æœˆã®æ—¥ä»˜ã‚’ç”Ÿæˆ
base_date = datetime(2024, 1, 1)
dates = [base_date + timedelta(days=np.random.randint(0, 31)) for _ in range(n_rows)]

data = {
    'æ—¥ä»˜': dates,
    'éƒ¨ç½²': np.random.choice(departments, n_rows, p=[0.5, 0.35, 0.15]),  # å–¶æ¥­éƒ¨å¤šã‚
    'æ‹…å½“è€…': np.random.choice(sales_reps, n_rows),
    'å•†å“': np.random.choice(products, n_rows),
    'æ•°é‡': np.random.randint(1, 20, n_rows),
    'å˜ä¾¡': np.random.choice([10000, 15000, 20000, 30000, 50000], n_rows)
}

df = pd.DataFrame(data)
df['é‡‘é¡'] = df['æ•°é‡'] * df['å˜ä¾¡']

# æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
df = df.sort_values('æ—¥ä»˜').reset_index(drop=True)

# ä¿å­˜
df.to_excel('sales_data_202401.xlsx', index=False)

print("ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†ã€‘")
print(f"ãƒ•ã‚¡ã‚¤ãƒ«: sales_data_202401.xlsx")
print(f"è¡Œæ•°: {len(df)}")
print(f"\nã€ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‘")
print(df.head(10))
print(f"\nã€é›†è¨ˆã€‘")
print(f"ç·å£²ä¸Š: Â¥{df['é‡‘é¡'].sum():,}")
```

**å®Ÿè¡Œçµæœï¼š**
```
ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†ã€‘
ãƒ•ã‚¡ã‚¤ãƒ«: sales_data_202401.xlsx
è¡Œæ•°: 200

ã€ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‘
         æ—¥ä»˜    éƒ¨ç½² æ‹…å½“è€…   å•†å“  æ•°é‡    å˜ä¾¡      é‡‘é¡
0  2024-01-01  å–¶æ¥­éƒ¨   é«˜æ©‹  å•†å“C    11  30000   330000
1  2024-01-01  é–‹ç™ºéƒ¨   éˆ´æœ¨  å•†å“A     8  20000   160000
2  2024-01-01  å–¶æ¥­éƒ¨   ä½è—¤  å•†å“B    15  15000   225000
...

ã€é›†è¨ˆã€‘
ç·å£²ä¸Š: Â¥52,830,000
```

---

## Step 1: ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§é›†è¨ˆ

```python
# ===== Step 1: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨é›†è¨ˆ =====
import pandas as pd

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
df = pd.read_excel('sales_data_202401.xlsx')

print("ã€åŸºæœ¬çµ±è¨ˆã€‘")
print(f"ç·å£²ä¸Š: Â¥{df['é‡‘é¡'].sum():,}")
print(f"å–å¼•ä»¶æ•°: {len(df)}ä»¶")
print(f"å¹³å‡å˜ä¾¡: Â¥{df['é‡‘é¡'].mean():,.0f}")

# éƒ¨é–€åˆ¥é›†è¨ˆ
dept_summary = df.groupby('éƒ¨ç½²').agg({
    'é‡‘é¡': ['sum', 'count', 'mean']
}).round(0)
dept_summary.columns = ['å£²ä¸Šåˆè¨ˆ', 'ä»¶æ•°', 'å¹³å‡å˜ä¾¡']
dept_summary = dept_summary.sort_values('å£²ä¸Šåˆè¨ˆ', ascending=False)

print("\nã€éƒ¨é–€åˆ¥å£²ä¸Šã€‘")
print(dept_summary)

# å•†å“åˆ¥é›†è¨ˆ
product_summary = df.groupby('å•†å“').agg({
    'é‡‘é¡': 'sum',
    'æ•°é‡': 'sum'
}).sort_values('é‡‘é¡', ascending=False)

print("\nã€å•†å“åˆ¥å£²ä¸Šã€‘")
print(product_summary)

# æ‹…å½“è€…åˆ¥é›†è¨ˆ
rep_summary = df.groupby('æ‹…å½“è€…')['é‡‘é¡'].sum().sort_values(ascending=False)
print("\nã€æ‹…å½“è€…åˆ¥å£²ä¸ŠTOP3ã€‘")
print(rep_summary.head(3))
```

**å®Ÿè¡Œçµæœï¼š**
```
ã€åŸºæœ¬çµ±è¨ˆã€‘
ç·å£²ä¸Š: Â¥52,830,000
å–å¼•ä»¶æ•°: 200ä»¶
å¹³å‡å˜ä¾¡: Â¥264,150

ã€éƒ¨é–€åˆ¥å£²ä¸Šã€‘
        å£²ä¸Šåˆè¨ˆ   ä»¶æ•°     å¹³å‡å˜ä¾¡
éƒ¨ç½²
å–¶æ¥­éƒ¨  27345000    99   276212.0
é–‹ç™ºéƒ¨  18130000    72   251806.0
ç·å‹™éƒ¨   7355000    29   253621.0

ã€å•†å“åˆ¥å£²ä¸Šã€‘
       é‡‘é¡   æ•°é‡
å•†å“
å•†å“D  16250000   85
å•†å“C  14820000  102
å•†å“A  11505000   88
å•†å“B  10255000   92

ã€æ‹…å½“è€…åˆ¥å£²ä¸ŠTOP3ã€‘
æ‹…å½“è€…
é«˜æ©‹    11780000
ç”°ä¸­    10420000
éˆ´æœ¨     9085000
Name: é‡‘é¡, dtype: int64
```

---

## Step 2: ã‚°ãƒ©ãƒ•ä»˜ããƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

openpyxlã§Excelã«ã‚°ãƒ©ãƒ•ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚

```python
# ===== Step 2: ã‚°ãƒ©ãƒ•ä»˜ããƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ =====
import pandas as pd
from openpyxl import Workbook
from openpyxl.chart import BarChart, PieChart, Reference
from openpyxl.chart.label import DataLabelList
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils.dataframe import dataframe_to_rows

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
df = pd.read_excel('sales_data_202401.xlsx')

# é›†è¨ˆ
total_sales = df['é‡‘é¡'].sum()
total_count = len(df)
avg_price = df['é‡‘é¡'].mean()

dept_summary = df.groupby('éƒ¨ç½²')['é‡‘é¡'].sum().sort_values(ascending=False)
product_summary = df.groupby('å•†å“')['é‡‘é¡'].sum().sort_values(ascending=False)

# ===== Excelãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ =====
wb = Workbook()

# ----- Sheet1: ã‚µãƒãƒªãƒ¼ -----
ws_summary = wb.active
ws_summary.title = "ã‚µãƒãƒªãƒ¼"

# ã‚¿ã‚¤ãƒˆãƒ«
ws_summary['A1'] = "2024å¹´1æœˆ å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ"
ws_summary['A1'].font = Font(size=18, bold=True)
ws_summary.merge_cells('A1:E1')

# åŸºæœ¬çµ±è¨ˆ
ws_summary['A3'] = "åŸºæœ¬çµ±è¨ˆ"
ws_summary['A3'].font = Font(size=14, bold=True)

stats = [
    ('ç·å£²ä¸Š', f'Â¥{total_sales:,}'),
    ('å–å¼•ä»¶æ•°', f'{total_count}ä»¶'),
    ('å¹³å‡å˜ä¾¡', f'Â¥{avg_price:,.0f}'),
]
for i, (label, value) in enumerate(stats, start=4):
    ws_summary[f'A{i}'] = label
    ws_summary[f'B{i}'] = value
    ws_summary[f'A{i}'].font = Font(bold=True)

# éƒ¨é–€åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
ws_summary['A8'] = "éƒ¨é–€åˆ¥å£²ä¸Š"
ws_summary['A8'].font = Font(size=14, bold=True)

ws_summary['A9'] = "éƒ¨ç½²"
ws_summary['B9'] = "å£²ä¸Š"
for i, (dept, sales) in enumerate(dept_summary.items(), start=10):
    ws_summary[f'A{i}'] = dept
    ws_summary[f'B{i}'] = sales

# éƒ¨é–€åˆ¥æ£’ã‚°ãƒ©ãƒ•
chart1 = BarChart()
chart1.type = "col"
chart1.title = "éƒ¨é–€åˆ¥å£²ä¸Š"
chart1.y_axis.title = "å£²ä¸Šï¼ˆå††ï¼‰"
chart1.x_axis.title = "éƒ¨é–€"

data = Reference(ws_summary, min_col=2, min_row=9, max_row=12)
cats = Reference(ws_summary, min_col=1, min_row=10, max_row=12)
chart1.add_data(data, titles_from_data=True)
chart1.set_categories(cats)
chart1.shape = 4
chart1.width = 12
chart1.height = 8

ws_summary.add_chart(chart1, "D3")

# å•†å“åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿
ws_summary['A15'] = "å•†å“åˆ¥å£²ä¸Š"
ws_summary['A15'].font = Font(size=14, bold=True)

ws_summary['A16'] = "å•†å“"
ws_summary['B16'] = "å£²ä¸Š"
for i, (product, sales) in enumerate(product_summary.items(), start=17):
    ws_summary[f'A{i}'] = product
    ws_summary[f'B{i}'] = sales

# å•†å“åˆ¥å††ã‚°ãƒ©ãƒ•
chart2 = PieChart()
chart2.title = "å•†å“åˆ¥å£²ä¸Šæ§‹æˆ"

data = Reference(ws_summary, min_col=2, min_row=16, max_row=20)
cats = Reference(ws_summary, min_col=1, min_row=17, max_row=20)
chart2.add_data(data, titles_from_data=True)
chart2.set_categories(cats)
chart2.width = 10
chart2.height = 8

# ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ«è¡¨ç¤º
chart2.dataLabels = DataLabelList()
chart2.dataLabels.showPercent = True
chart2.dataLabels.showVal = False
chart2.dataLabels.showCatName = True

ws_summary.add_chart(chart2, "D15")

# ----- Sheet2: è©³ç´°ãƒ‡ãƒ¼ã‚¿ -----
ws_detail = wb.create_sheet(title="è©³ç´°ãƒ‡ãƒ¼ã‚¿")

# DataFrameã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
for r_idx, row in enumerate(dataframe_to_rows(df, index=False, header=True), start=1):
    for c_idx, value in enumerate(row, start=1):
        cell = ws_detail.cell(row=r_idx, column=c_idx, value=value)
        if r_idx == 1:  # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            cell.font = Font(bold=True)
            cell.fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
            cell.font = Font(bold=True, color="FFFFFF")

# åˆ—å¹…èª¿æ•´
ws_detail.column_dimensions['A'].width = 12
ws_detail.column_dimensions['B'].width = 10
ws_detail.column_dimensions['C'].width = 10
ws_detail.column_dimensions['D'].width = 10
ws_detail.column_dimensions['E'].width = 8
ws_detail.column_dimensions['F'].width = 10
ws_detail.column_dimensions['G'].width = 12

# ----- ä¿å­˜ -----
output_file = 'å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ_2024å¹´1æœˆ.xlsx'
wb.save(output_file)

print(f"ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: {output_file}")
print(f"\nã€ãƒ¬ãƒãƒ¼ãƒˆæ§‹æˆã€‘")
print(f"  Sheet1: ã‚µãƒãƒªãƒ¼ï¼ˆåŸºæœ¬çµ±è¨ˆ + ã‚°ãƒ©ãƒ•2ã¤ï¼‰")
print(f"  Sheet2: è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆ{len(df)}è¡Œï¼‰")
```

**å®Ÿè¡Œçµæœï¼š**
```
ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ_2024å¹´1æœˆ.xlsx

ã€ãƒ¬ãƒãƒ¼ãƒˆæ§‹æˆã€‘
  Sheet1: ã‚µãƒãƒªãƒ¼ï¼ˆåŸºæœ¬çµ±è¨ˆ + ã‚°ãƒ©ãƒ•2ã¤ï¼‰
  Sheet2: è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆ200è¡Œï¼‰
```

---

## Step 3: å®Œæˆã‚³ãƒ¼ãƒ‰ï¼ˆã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ï¼‰

ã“ã“ã¾ã§ã®å‡¦ç†ã‚’1ã¤ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¾ã¨ã‚ã¾ã™ã€‚

```python
# ===== å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ« =====
# sales_report_generator.py
#
# ä½¿ã„æ–¹:
# 1. sales_data_YYYYMM.xlsx ã‚’åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã
# 2. ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
# 3. ã€Œå£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ_YYYYå¹´MMæœˆ.xlsxã€ãŒç”Ÿæˆã•ã‚Œã‚‹

import pandas as pd
from openpyxl import Workbook
from openpyxl.chart import BarChart, PieChart, Reference
from openpyxl.chart.label import DataLabelList
from openpyxl.styles import Font, PatternFill
from openpyxl.utils.dataframe import dataframe_to_rows
import os
import glob
from datetime import datetime

def generate_sales_report(input_file):
    """å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚°ãƒ©ãƒ•ä»˜ããƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""

    # ===== 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
    print(f"èª­ã¿è¾¼ã¿ä¸­: {input_file}")
    df = pd.read_excel(input_file)

    # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å¹´æœˆã‚’å–å¾—
    # ä¾‹: sales_data_202401.xlsx â†’ 2024å¹´1æœˆ
    basename = os.path.basename(input_file)
    if 'sales_data_' in basename:
        ym = basename.replace('sales_data_', '').replace('.xlsx', '')
        year = ym[:4]
        month = ym[4:6]
        title = f"{year}å¹´{int(month)}æœˆ å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ"
    else:
        title = "å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ"
        year = datetime.now().year
        month = datetime.now().month

    # ===== 2. é›†è¨ˆ =====
    total_sales = df['é‡‘é¡'].sum()
    total_count = len(df)
    avg_price = df['é‡‘é¡'].mean()

    dept_summary = df.groupby('éƒ¨ç½²')['é‡‘é¡'].sum().sort_values(ascending=False)
    product_summary = df.groupby('å•†å“')['é‡‘é¡'].sum().sort_values(ascending=False)

    # ===== 3. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ =====
    wb = Workbook()

    # ----- Sheet1: ã‚µãƒãƒªãƒ¼ -----
    ws = wb.active
    ws.title = "ã‚µãƒãƒªãƒ¼"

    # ã‚¿ã‚¤ãƒˆãƒ«
    ws['A1'] = title
    ws['A1'].font = Font(size=18, bold=True)
    ws.merge_cells('A1:E1')

    # åŸºæœ¬çµ±è¨ˆ
    ws['A3'] = "åŸºæœ¬çµ±è¨ˆ"
    ws['A3'].font = Font(size=14, bold=True)

    ws['A4'] = "ç·å£²ä¸Š"
    ws['B4'] = f'Â¥{total_sales:,}'
    ws['A5'] = "å–å¼•ä»¶æ•°"
    ws['B5'] = f'{total_count}ä»¶'
    ws['A6'] = "å¹³å‡å˜ä¾¡"
    ws['B6'] = f'Â¥{avg_price:,.0f}'

    for i in range(4, 7):
        ws[f'A{i}'].font = Font(bold=True)

    # éƒ¨é–€åˆ¥å£²ä¸Š
    ws['A8'] = "éƒ¨é–€åˆ¥å£²ä¸Š"
    ws['A8'].font = Font(size=14, bold=True)
    ws['A9'] = "éƒ¨ç½²"
    ws['B9'] = "å£²ä¸Š"

    for i, (dept, sales) in enumerate(dept_summary.items(), start=10):
        ws[f'A{i}'] = dept
        ws[f'B{i}'] = sales

    # æ£’ã‚°ãƒ©ãƒ•
    chart1 = BarChart()
    chart1.type = "col"
    chart1.title = "éƒ¨é–€åˆ¥å£²ä¸Š"
    data = Reference(ws, min_col=2, min_row=9, max_row=9+len(dept_summary))
    cats = Reference(ws, min_col=1, min_row=10, max_row=9+len(dept_summary))
    chart1.add_data(data, titles_from_data=True)
    chart1.set_categories(cats)
    chart1.width = 12
    chart1.height = 8
    ws.add_chart(chart1, "D3")

    # å•†å“åˆ¥å£²ä¸Š
    start_row = 10 + len(dept_summary) + 2
    ws[f'A{start_row}'] = "å•†å“åˆ¥å£²ä¸Š"
    ws[f'A{start_row}'].font = Font(size=14, bold=True)
    ws[f'A{start_row+1}'] = "å•†å“"
    ws[f'B{start_row+1}'] = "å£²ä¸Š"

    for i, (product, sales) in enumerate(product_summary.items(), start=start_row+2):
        ws[f'A{i}'] = product
        ws[f'B{i}'] = sales

    # å††ã‚°ãƒ©ãƒ•
    chart2 = PieChart()
    chart2.title = "å•†å“åˆ¥å£²ä¸Šæ§‹æˆ"
    data = Reference(ws, min_col=2, min_row=start_row+1, max_row=start_row+1+len(product_summary))
    cats = Reference(ws, min_col=1, min_row=start_row+2, max_row=start_row+1+len(product_summary))
    chart2.add_data(data, titles_from_data=True)
    chart2.set_categories(cats)
    chart2.width = 10
    chart2.height = 8
    chart2.dataLabels = DataLabelList()
    chart2.dataLabels.showPercent = True
    chart2.dataLabels.showCatName = True
    ws.add_chart(chart2, "D15")

    # ----- Sheet2: è©³ç´°ãƒ‡ãƒ¼ã‚¿ -----
    ws_detail = wb.create_sheet(title="è©³ç´°ãƒ‡ãƒ¼ã‚¿")

    for r_idx, row in enumerate(dataframe_to_rows(df, index=False, header=True), start=1):
        for c_idx, value in enumerate(row, start=1):
            cell = ws_detail.cell(row=r_idx, column=c_idx, value=value)
            if r_idx == 1:
                cell.fill = PatternFill(start_color="4472C4", fill_type="solid")
                cell.font = Font(bold=True, color="FFFFFF")

    # åˆ—å¹…èª¿æ•´
    for col in ['A', 'B', 'C', 'D', 'E', 'F', 'G']:
        ws_detail.column_dimensions[col].width = 12

    # ===== 4. ä¿å­˜ =====
    output_file = f'å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ_{year}å¹´{int(month)}æœˆ.xlsx'
    wb.save(output_file)

    return output_file, total_sales, total_count

# ===== ãƒ¡ã‚¤ãƒ³å‡¦ç† =====
if __name__ == "__main__":
    print("=" * 50)
    print("  å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«")
    print("=" * 50)

    # å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    files = glob.glob('sales_data_*.xlsx')

    if not files:
        print("\nâŒ ã‚¨ãƒ©ãƒ¼: sales_data_*.xlsx ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print("   sales_data_YYYYMM.xlsx å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„")
    else:
        print(f"\nå‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: {len(files)}ä»¶")
        for f in files:
            output, sales, count = generate_sales_report(f)
            print(f"\nâœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†")
            print(f"   å…¥åŠ›: {f}")
            print(f"   å‡ºåŠ›: {output}")
            print(f"   ç·å£²ä¸Š: Â¥{sales:,}")
            print(f"   ä»¶æ•°: {count}ä»¶")

    print("\n" + "=" * 50)
    input("Enterã‚­ãƒ¼ã§çµ‚äº†...")
```

---

## GASã¨ã®æ¯”è¼ƒ

```javascript
// GAS: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚°ãƒ©ãƒ•ã‚’è¿½åŠ ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function createChart() {
  const sheet = SpreadsheetApp.getActiveSheet();
  const range = sheet.getRange('A1:B10');

  const chart = sheet.newChart()
    .setChartType(Charts.ChartType.BAR)
    .addRange(range)
    .setPosition(1, 4, 0, 0)
    .build();

  sheet.insertChart(chart);
}
// â€» Excelãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å‡ºåŠ›ã¯ä¸å¯
```

```python
# Python: Excelã«ã‚°ãƒ©ãƒ•ã‚’è¿½åŠ 
from openpyxl.chart import BarChart, Reference

chart = BarChart()
chart.title = "å£²ä¸Šã‚°ãƒ©ãƒ•"
data = Reference(ws, min_col=2, min_row=1, max_row=10)
chart.add_data(data)
ws.add_chart(chart, "D1")
wb.save('output.xlsx')
# â†’ Excelãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜å¯èƒ½
```

**Pythonã®å„ªä½ç‚¹:**
- Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsxï¼‰ã«ç›´æ¥ã‚°ãƒ©ãƒ•ã‚’åŸ‹ã‚è¾¼ã‚ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾é…å¸ƒå¯èƒ½
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®å¤‰æ›ä¸è¦

---

## ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

### ã‚¨ãƒ©ãƒ¼1: openpyxl.chart ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ããªã„

```
ModuleNotFoundError: No module named 'openpyxl.chart'
```

**å¯¾å‡¦æ³•:** openpyxlãŒæ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```
pip install openpyxl --upgrade
```

### ã‚¨ãƒ©ãƒ¼2: ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œãªã„

```
Excelã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ãŸãŒã‚°ãƒ©ãƒ•ãŒEmpty
```

**å¯¾å‡¦æ³•:** ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã®æŒ‡å®šã‚’ç¢ºèª

```python
# é–“é•ã„: ãƒ‡ãƒ¼ã‚¿ãŒãªã„ç¯„å›²ã‚’æŒ‡å®š
data = Reference(ws, min_col=2, min_row=1, max_row=1)  # 1è¡Œã ã‘

# æ­£ã—ã„: ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ç¯„å›²ã‚’æŒ‡å®š
data = Reference(ws, min_col=2, min_row=1, max_row=10)  # è¤‡æ•°è¡Œ
```

---

## ã“ã®ç¯€ã®ã¾ã¨ã‚

- `openpyxl.chart` ã§Excelã«ã‚°ãƒ©ãƒ•ã‚’åŸ‹ã‚è¾¼ã‚ã‚‹
- `BarChart`ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰ã€`PieChart`ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰ãŒä½¿ãˆã‚‹
- `Reference` ã§ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã‚’æŒ‡å®š
- pandasã§é›†è¨ˆ â†’ openpyxlã§ãƒ¬ãƒãƒ¼ãƒˆåŒ–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¼·åŠ›
- çµŒç†éƒ¨ã«æ¸¡ã›ã‚‹å“è³ªã®Excelãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã§ããŸ

**æ¬¡ã®ç¯€ã§ã¯ã€100æšã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’3ç§’ã§çµ±åˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ä½œã‚Šã¾ã™ï¼**
